{% extends "index/base.html" %}
{% load static %}
{% block title %}Producto{% endblock title %}
{% block body %}

    <div class="reg-btn">
        <a onclick="window.history.back();" class="regresar">
            <span class="material-symbols-outlined">chevron_left</span> Regresar
        </a>
    </div>
    

    <div class="prod-detalle">
        <div class="izq">
            <img src="{{ producto.imagen.url }}" class="img">
        </div>
        <div class="der">
            <h2 class="der-titulo">{{ producto.nombre }}</h2>
            <p class="precio">$ <!--${{ producto.precio }}--></p>
            <p><strong>Detalles del Producto:</strong> (Aquí puedes agregar más detalles)</p>
            <p><strong>Publicado por:</strong> {{ producto.usuario.username }}</p>
            <p><strong>Estado:</strong> {{producto.estado}} </p>
            <p><strong>Dirección:</strong> {{ producto.direccion }}</p>
            <p><strong>Para:</strong> {{ producto.tipo }}</p>

            <!-- Agrega más detalles según lo necesites -->
            <a href="{% url 'detailms' username=producto.usuario.username %}" class="btn">Me Interesa</a>
        </div>
    </div>

    <h3 class="prod-dest">Deja tu comentario</h3>
    {% if user.is_authenticated %}
        <form method="post" class="comment-form">
            {% csrf_token %}

            <!-- ⭐⭐ Aquí agregamos las estrellas ⭐⭐ -->
            <div id="star-rating" class="stars" style="cursor: pointer;">
                <span data-value="1">★</span>
                <span data-value="2">★</span>
                <span data-value="3">★</span>
                <span data-value="4">★</span>
                <span data-value="5">★</span>
            </div>

            <!-- Campo oculto para almacenar el puntaje -->
            {{ form.puntaje }}

            <div class="form-group">
                {{ form.comentario.label_tag }}
                {{ form.comentario }}
            </div>

            <button type="submit" class="btn btn-success mt-2">Enviar Calificación</button>
        </form>
        {% else %}
            <p><a href="{% url 'login' %}">Inicia sesión</a> para calificar este producto.</p>
        {% endif %}

    <hr>

    <h3 class="prod-dest">Opiniones de otros usuarios:</h3>

    <div class="calificaciones">
        {% for calificacion_data in calificaciones %}
            {% with calificacion=calificacion_data.calificacion %}
            <div class="cal-card">
                <div class="cal-card-body">
                    <div class="cal-header">
                        {% if calificacion_data.foto_perfil %}
                            <img src="{{ calificacion_data.foto_perfil }}" alt="Foto de perfil" class="cal-avatar">
                        {% else %}
                            <img src="{% static 'images/default_profile.jpg' %}" alt="Foto predeterminada" class="cal-avatar">
                        {% endif %}
        
                        <div class="cal-user-info">
                            <h5 class="cal-card-titulo">{{ calificacion.usuario.username }}</h5>
                            <div class="cal-rating">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= calificacion.puntaje %}
                                        <span class="star full">★</span>
                                    {% else %}
                                        <span class="star">☆</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
        
                    <p class="cal-card-texto">{{ calificacion.comentario }}</p>
                </div>
            </div>
            {% endwith %}
        {% empty %}
            <p>No hay calificaciones todavía.</p>
        {% endfor %}
    </div>


    <script>
        const stars = document.querySelectorAll('#star-rating span');
        const ratingInput = document.getElementById('id_puntaje');  // campo oculto
        let currentRating = 0;
    
        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const rating = star.getAttribute('data-value');
                highlightStars(rating);
            });
    
            star.addEventListener('mouseout', () => {
                highlightStars(currentRating);
            });
    
            star.addEventListener('click', () => {
                currentRating = star.getAttribute('data-value');
                ratingInput.value = currentRating;
            });
        });
    
        function highlightStars(rating) {
            stars.forEach(star => {
                if (star.getAttribute('data-value') <= rating) {
                    star.style.color = '#ffc107'; // color amarillo
                } else {
                    star.style.color = '#ddd'; // color gris claro
                }
            });
        }
    </script>
{% endblock %}