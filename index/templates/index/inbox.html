{% extends "index/base.html" %}
{% load static %}
{% block title %}Mis Mensajes{% endblock title %}
{% block body %}

    <div class="chat-wrapper">
        <!-- Lista de conversaciones -->
        <div class="chat-sidebar">
            <h2>Chats</h2>
            {% for inbox in inbox %}
                {% for second_user in inbox.canalusuario_set.all %}
                    {% if second_user.usuario != request.user %}
                        <a href="?canal_id={{inbox.id}}" class="chat-item">
                            <div class="chat-avatar">
                                {% if second_user.usuario.perfil.foto_perfil %}
                                    <img src="{{ second_user.usuario.perfil.foto_perfil.url }}" alt="Avatar">
                                {% else %}
                                    <img src="{% static 'img/usuario.png' %}" alt="Avatar">
                                {% endif %}
                            </div>
                            <div> 
                                {% if inbox.canalmensaje_set.count != 0 %}
                                    <div class="div_ms_inbox">
                                        {% with ultimo_mensaje=inbox.canalmensaje_set.all|dictsortreversed:"tiempo"|first %}
                                            <strong>{{ second_user.usuario }}</strong><br>
                                            <small>({{ inbox.canalmensaje_set.count }}) Mensajes: {{ultimo_mensaje.texto}}</small>
                                        {% endwith %}
                                    </div>
                                {% endif %}
                            </div>
                        </a>
                    {% endif %}
                {% endfor %}
            {% empty %}
                <p>Inbox Vacío</p>
            {% endfor %}
        </div>

        <!-- Área de mensajes -->
        <div class="chat-main">
            {% if canal %}
                <div class="chat-header">
                    {% if canal %}
                        {% for usuario in canal.usuarios.all %}
                            {% if usuario != request.user %}
                                <div class="chat-header-user1">
                                    <!-- Foto de perfil -->
                                    <div class="chat-avatar1">
                                        {% if usuario.perfil.foto_perfil %}
                                            <img src="{{ usuario.perfil.foto_perfil.url }}" alt="Avatar" width="40px" height="40px">
                                        {% else %}
                                            <img src="{% static 'img/usuario.png' %}" alt="Avatar" width="40px" height="40px">
                                        {% endif %}
                                    </div>
                                    <!-- Nombre del usuario -->
                                    <div class="chat-username1">   
                                        <a href="{% url 'perfil_publico' usuario.username %}">{{usuario.username }}</a>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="chat-messages">
                    {% for mensaje in canal.canalmensaje_set.all|dictsort:"tiempo" %}
                        <div class="message-bubble {% if request.user == mensaje.usuario %}own{% else %}other{% endif %}">
                            <div class="message-content">
                                <p>{{ mensaje.texto|safe }}</p>
                                <small>{{ mensaje.tiempo }}</small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <!-- Boton de Confirmar Entrega Vendedor/Prosumidor -->
                {% if producto_relacionado and es_duenio_producto %}
                    <!-- Botón que abre el modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
                        Confirmar Entrega
                    </button>
                    
                    <!-- Modal Bootstrap -->
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form id="confirmForm" method="POST">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="confirmModalLabel">Confirmar Entrega / Intercambio</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label>Producto:</label>
                                            <p><strong>{{ producto_relacionado.nombre }}</strong></p>
                                        </div>
                                        <div class="mb-3">
                                            <label for="lugar" class="form-label">Lugar</label>
                                            <input type="text" class="form-control" name="lugar" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="fecha" class="form-label">Fecha</label>
                                            <input type="date" class="form-control" name="fecha" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="hora" class="form-label">Hora</label>
                                            <input type="time" class="form-control" name="hora" required>
                                        </div>
                                        <!-- Mostrar nombre del producto como texto no editable -->
                                        
                                        <!-- Enviar el ID del producto de forma oculta -->
                                        <input type="hidden" name="producto_id" value="{{ producto_relacionado.id_producto }}">
                                        <input type="hidden" name="canal_id" value="{{ canal.id }}">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Confirmar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                {% if mostrar_botones|default:False %}
                    <!-- Botón que abre el modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calificarModal">
                        Recibido
                    </button>

                    <!-- Modal para calificar al vendedor -->
                    <div class="modal fade" id="calificarModal" tabindex="-1" aria-labelledby="calificarModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form id="calificarForm" method="POST" action="{% url 'calificar_vendedor' %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="calificarModalLabel">Calificar al Vendedor</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <!-- ⭐⭐ Estrellas para calificar ⭐⭐ -->
                                            <div id="star-rating" class="stars mb-3" style="cursor: pointer; font-size: 1.8rem;">
                                                <span data-value="1">★</span>
                                                <span data-value="2">★</span>
                                                <span data-value="3">★</span>
                                                <span data-value="4">★</span>
                                                <span data-value="5">★</span>
                                            </div>

                                            <!-- Campo oculto para almacenar el puntaje -->
                                            <input type="hidden" name="puntaje" id="id_puntaje" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="comentario" class="form-label">Comentario</label>
                                            <textarea class="form-control" name="comentario"></textarea>
                                        </div>
                                        <!-- Aquí van los campos ocultos con la información del producto y el vendedor -->
                                        <input type="hidden" name="producto_id" value="{{ producto_relacionado.id_producto }}">
                                        <input type="hidden" name="vendedor_id" value="{{ producto_relacionado.usuario.id }}">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Confirmar Calificación</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Botón que abre el modal -->
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#reporteModal">
                        No se concretó
                    </button>

                    <!-- Modal para reportar vendedor -->
                    <div class="modal fade" id="reporteModal" tabindex="-1" aria-labelledby="reporteModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form id="reporteForm" method="POST" action="{% url 'reportar_vendedor' %}">
                                    {% csrf_token %}
                                    <div class="modal-header">
                                        <h5 class="modal-title">Reportar al Vendedor</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- ⭐⭐ Estrellas para puntuar ⭐⭐ -->
                                        <div id="star-rating-report" class="stars mb-3" style="cursor: pointer; font-size: 1.8rem;">
                                            <span data-value="1">★</span>
                                            <span data-value="2">★</span>
                                            <span data-value="3">★</span>
                                            <span data-value="4">★</span>
                                            <span data-value="5">★</span>
                                        </div>

                                        <!-- Campo oculto para almacenar el puntaje del reporte -->
                                        <input type="hidden" name="puntaje" id="id_puntaje_report" required>
                                        <div class="mb-3">
                                            <label for="motivo" class="form-label">Motivo del reporte</label>
                                            <textarea class="form-control" name="motivo" required></textarea>
                                        </div>
                                        <input type="hidden" name="producto_id" value="{{ producto_relacionado.id_producto }}">
                                        <input type="hidden" name="vendedor_id" value="{{ producto_relacionado.usuario.id }}">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-danger">Enviar Reporte</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <form class="chat-input" action="?canal_id={{ canal.id }}" method="POST">
                    {% csrf_token %}
                    <input type="text" name="mensaje" placeholder="Escribe un mensaje..." />
                    <button type="submit" class="send-button">
                        <img src="{% static 'img/enviar.png' %}" alt="Enviar mensaje" width="30px" height="30px">
                    </button>
                </form>
            {% else %}
                <p>Selecciona un canal para comenzar a chatear.</p>
            {% endif %}
        </div>
        
    </div>

    <script>
        // ⭐ Interactividad de estrellas para calificar vendedor ⭐
        const stars = document.querySelectorAll('#star-rating span');
        const ratingInput = document.getElementById('id_puntaje');
        let currentRating = 0;

        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const rating = star.getAttribute('data-value');
                highlightStars(rating);
            });

            star.addEventListener('mouseout', () => {
                highlightStars(currentRating);
            });

            star.addEventListener('click', () => {
                currentRating = star.getAttribute('data-value');
                ratingInput.value = currentRating;
            });
        });

        function highlightStars(rating) {
            stars.forEach(star => {
                if (star.getAttribute('data-value') <= rating) {
                    star.style.color = '#ffc107'; // amarillo
                } else {
                    star.style.color = '#ddd'; // gris claro
                }
            });
        }
        // ⭐ Interactividad de estrellas en reporte ⭐
        const reportStars = document.querySelectorAll('#star-rating-report span');
        const ratingInputReport = document.getElementById('id_puntaje_report');
        let currentReportRating = 0;

        reportStars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const rating = star.getAttribute('data-value');
                highlightReportStars(rating);
            });

            star.addEventListener('mouseout', () => {
                highlightReportStars(currentReportRating);
            });

            star.addEventListener('click', () => {
                currentReportRating = star.getAttribute('data-value');
                ratingInputReport.value = currentReportRating;
            });
        });

        function highlightReportStars(rating) {
            reportStars.forEach(star => {
                if (star.getAttribute('data-value') <= rating) {
                    star.style.color = '#ffc107';
                } else {
                    star.style.color = '#ddd';
                }
            });
        } 
        document.getElementById("confirmForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("{% url 'guardar_confirmacion_entrega' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "ok") {
                    alert("Confirmación guardada correctamente.");
                    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                    modal.hide();
                } else {
                    alert("Error: " + JSON.stringify(data.errores));
                }
            });
        });

        document.getElementById("calificarForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("{% url 'calificar_vendedor' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "ok") {
                    // Mostrar el mensaje de éxito aquí
                    alert("Gracias por calificar al vendedor.");
                } else {
                    // Mostrar el mensaje de error aquí
                    alert("Error: " + data.mensaje);
                }
            })
            .catch(error => {
                alert("Hubo un problema al enviar la calificación.");
            });
        });

        document.getElementById("reporteForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("{% url 'reportar_vendedor' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "ok") {
                    alert("Reporte enviado correctamente.");
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reporteModal'));
                    modal.hide();
                } else {
                    alert("Error al enviar reporte: " + JSON.stringify(data.errors || data.message));
                }
            })
            .catch(() => alert("Hubo un problema al enviar el reporte."));
        });
    </script>
{% endblock %}